@model TestDA.Areas.Manager.Models.ViewModel.TPMonAn

@{
    ViewBag.Title = "SuaTPMA";
    Layout = "~/Areas/Manager/Views/Shared/_AdminPartial.cshtml";
}

<section class="content-header">
    <h1>
        <i class="fa fa-building-o"></i>
        Món ăn
        <small></small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Trang chủ</a></li>
        <li class="active">Món ăn</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <div class="container body-content body-suaMonAn">
        <h3>Sửa thông tin thành phần món ăn</h3>
        <p><label class="control-label"><b>Tên món ăn:</b></label> <a href="/Manager/MonAn/SuaMonAn?type=Edit&maMonAn=@ViewBag.maMonAn">@ViewBag.tenMonAn </a> </p>
        @using (Html.BeginForm("ThemTPMonAn", "MonAn", FormMethod.Post, new { @class = "form-inline", @id = "themThucPham" }))
        {
            @Html.AntiForgeryToken()
            <div>
                @*/thêm thực phẩm vào món ăn/*@
                <fieldset class="the-fieldset">
                    <legend class="the-legend">Thêm mới thành phần món ăn</legend>
                    <div class="col-md-6">
                        @{
            Model.maMonAn = ViewBag.maMonAn;
                        }
                        @Html.HiddenFor(model => model.maMonAn)
                        <div class="">
                            <label class="">Chọn thực phẩm</label>
                            @*<div class="">
                            *@
                            @Html.DropDownListFor(model => model.maThucPham, null, "--Chọn thực phẩm-- ", new { @class = "form-control" })
                            @Html.ValidationMessageFor(model => model.maThucPham, null, new { @class = "text-danger" })
                            @*@Html.DropDownList("maThucPham", @ViewBag.maThucPham as SelectList, "--Chọn thực phẩm--", new { @class = "form-control", @id = "thucPham" })
                                <span class="message-error-tp" style="color:red;"></span>*@
                            @*
                                </div>*@
                        </div>
                        <div class="">
                            <label class="">Số lượng (g)</label>
                            @Html.EditorFor(model => model.soLuongGam, new { htmlAttributes = new { @class = "form-control" } })
                            @Html.ValidationMessageFor(model => model.soLuongGam, null, new { @class = "text-danger" })
                            @*<input type="text" class="form-control" placeholder="Số lượng(kg)..." name="soLuongTP" id="soLuongTP">
                                <span class="message-error-sl" style="color:red;"></span>*@
                        </div>
                        <div class="" style="margin-top:10px;">
                            <button type="submit" class="btn btn-primary" data-value="@Model.maMonAn"><i class="fa fa-plus"></i>Thêm thực phẩm</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="">Ghi chú</label>
                        @Html.TextAreaFor(model => model.ghiChu, new { @class = "form-control", @rows = 5 })
                        @Html.ValidationMessageFor(model => model.ghiChu, null, new { @class = "text-danger" })
                    </div>
                </fieldset>
            </div>@*Thêm thực phẩm vào món ăn*@
        }
        <div class="suaTPMonAn">
            @*load thông tin thành phần món ăn*@
            <table class="table table-bordered table-hover" id="dstpMonAn">
                <thead>
                    <tr style=" text-align:center; background:#ffefd5;">
                        <th rowspan="3" style="width:9%;">Thực phẩm</th>
                        <th rowspan="3">Số lượng(g)</th>
                        <th colspan="14" style="text-align:center;">Thành phần dinh dưỡng</th>
                        <th rowspan="3">Ghi chú</th>
                    </tr>
                    <tr class="thpdd" style="background: #fff5ee;">
                        <th>Protid ĐV</th>
                        <th>Protid TV</th>
                        <th>Lipid ĐV</th>
                        <th>Lipid TV</th>
                        <th>Glucid</th>
                        <th>Calo</th>
                        <th>Canxi</th>
                        <th>Photpho</th>
                        <th>Sắt</th>
                        <th>Vitamin A</th>
                        <th>Vitamin B1</th>
                        <th>Vitamin B2</th>
                        <th>Vitamin PP</th>
                        <th>Vitamin C</th>
                    </tr>
                    <tr class="dvtinh" style="background: #fff5ee;">
                        <td>g</td>
                        <td>g</td>
                        <td>g</td>
                        <td>g</td>
                        <td>g</td>
                        <td>KCal</td>
                        <td>g</td>
                        <td>g</td>
                        <td>mg</td>
                        <td>mg</td>
                        <td>mg</td>
                        <td>mg</td>
                        <td>mcg</td>
                        <td>mcg</td>
                    </tr>
                </thead>
                <tbody>
                    @{
                        if (Model.danhSachTPMonAn.Count > 0)
                        {
                            //int j = 0;
                            foreach (var i in Model.danhSachTPMonAn)
                            {
                                // j++;
                                <tr>
                                    @*>@j.ToString()*@
                                    <td style="text-align:center;">
                                        @Html.DisplayFor(m => i.tenThucPham)
                                        <div>
                                            <a href="javacript:void(0)" class="lnkDelete" data-value="@i.maMonAnCT" id="group_@i.maMonAnCT">Xóa |</a>
                                            <a href="javacript:void(0)" class="lnkEdit" data-value="@i.maThucPham" data-ma="@i.maMonAnCT">Sửa</a>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="showSoLuong">@Html.DisplayFor(m => i.soLuongGam)</span>
                                        @Html.Editor("mSoLuongGam", new { htmlAttributes = new { @class = "form-control", @style = "display:none;", @id = "msoLuongGam" } })
                                    </td>
                                    <td> @Html.DisplayFor(m => i.protidDV)</td>
                                    <td> @Html.DisplayFor(m => i.protidTV)</td>
                                    <td> @Html.DisplayFor(m => i.lipidDV)</td>
                                    <td> @Html.DisplayFor(m => i.lipidTV)</td>
                                    <td> @Html.DisplayFor(m => i.glucid)</td>
                                    <td> @Html.DisplayFor(m => i.calo)</td>
                                    <td> @Html.DisplayFor(m => i.canxi)</td>
                                    <td> @Html.DisplayFor(m => i.photPho)</td>
                                    <td> @Html.DisplayFor(m => i.sat)</td>
                                    <td> @Html.DisplayFor(m => i.vitaminA)</td>
                                    <td> @Html.DisplayFor(m => i.vitaminB1)</td>
                                    <td> @Html.DisplayFor(m => i.vitaminB2)</td>
                                    <td> @Html.DisplayFor(m => i.vitaminPP)</td>
                                    <td> @Html.DisplayFor(m => i.vitaminC)</td>
                                    <td> @Html.DisplayFor(m => i.ghiChu)</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="20"> <p style="text-align:center;">Không có bản ghi nào</p></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>@*kết thúc bảng thành phần chi tiết món ăn*@
        <div class="">
            <br />@Html.ActionLink("<< Quay lại danh sách món ăn", "Index", "MonAn")
        </div>
    </div>@*kết thúc sửa thông tin*@
</section>
@section Scripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            //sửa thông tin thực phẩm
            $("a.lnkEdit").on("click", function () {
                var $tr = $(this).closest('tr');
                $(this).hide();
                var id = $(this).data('value');//lấy giá trị id ==mã thực phẩm
                var maTPCT = $(this).data('ma');//lấy giá trị id ==mã chi tiết
                console.log(maTPCT);
                $tr.find("a.lnkDelete").after("<a href='javacript:void(0)' class='lnkSave' data-value='" + id + "'>Lưu</a>");
                $tr.find(".showSoLuong").hide();
                $tr.find('#msoLuongGam').show().focus();
                //lấy giá trị của span
                var value = $tr.find(".showSoLuong").html();
                $tr.find('#msoLuongGam').val(value);

                $tr.find("a.lnkSave").on("click", function () {
                    var maTP = $("#thucPham").val();//lấy id mã thực
                    var soLuong = $tr.find("#msoLuongGam").val();//lấy số lượng món ăn
                    console.log(soLuong);
                    //kiểm tra thông tin nhập vào
                    var checkNumber = /^((\d+(\.\d *)?)|((\d*\.)?\d+))$/;
                    if(!checkNumber.test(soLuong) || (soLuong == "")) {
                        $tr.find("#msoLuongGam").css("border-color", "#a70909");
                        return false;
                    } else {
                        
                        //thực hiện update lại thành phần dinh dưỡng của thực phẩm
                        $.ajax({
                            type: "POST",
                            url: "@(Url.Action("SuaTPMonAn", "MonAn"))",
                            data: { maMonAnCT: maTPCT, maThucPham: id, soLuongGam: soLuong },
                            success: function (data) {
                                if (data == 0) {
                                    //$tr.fadeOut("border-color", "#ec645e");
                                    location.reload();
                                    $tr.find("#msoLuongGam").css("border-color", "#ccc");
                                    $tr.find("a.lnkSave").hide();
                                    $tr.find("a.lnkEdit").show();
                                    $tr.find(".showSoLuong").show();
                                    $tr.find('#msoLuongGam').hide();
                                } else {
                                    //
                                }
                            },
                            error: function (error) {
                            }
                        });
                        //end ajax                       
                    }
                });///
                //$tr.find("#msoLuongGam").focusout(function () {
                //    $(this).hide();
                //    $(this).prev().html($(this).val());
                //    $(this).prev().show();
                //    $tr.find("a.lnkDelete").append("<a href='javacript:void(0)' class='lnkEdit' data-value='" + id + "' data-ma='" + maTPCT + ">Sửa</a>");
                //});
                return false;
            });
            //xóa một bản ghi
            $("a.lnkDelete").on("click", function () {
                var id = $(this).data('value');//lấy giá trị id của bản ghi
                console.log(id);
                var $tr = $(this).closest('tr');
                var answer = confirm("Bạn có chắc chắn xóa bản ghi này?. Tiếp tục?");
                if (answer)
                    $.ajax({
                        type: "POST",
                        url: "@(Url.Action("XoaTPMonAn", "MonAn"))",
                        data: { maMonAnCT: id },
                        success: function (data) {
                            if (data == 0) {
                                $tr.css("background-color", "#ec645e");
                                $tr.fadeOut(1600, "linear", function () { $tr.remove(); });
                                location.reload();
                            } else {
                                //
                            }
                        },
                        error: function (error) {
                        }
                    });
                return false;
            });
        })//Xóa một bản ghi
    </script>
}
